#############################################
name: '<<YOUR PIPELINE NAME CONFIG>>'

trigger:
- master
- feature/*

pool:
  name: w7pool

variables:
  dockerRegistryServiceConnection: demo-acr
  imageRepository: w8-private-acr-repo
  containerRegistry: stasprivateacr.azurecr.io
  dockerfilePath: Dockerfile
  tag: $(Build.BuildNumber)

stages:
  - stage: CI
    jobs:
      - job: install_prerequisites
        workspace:
          clean: all
        steps:
          - task: Docker@2
            inputs:
              containerRegistry: $(dockerRegistryServiceConnection)
              repository: $(imageRepository)
              command: buildAndPush
              Dockerfile: $(dockerfilePath)
              tags: $(tag)

- task: ManualValidation@0
  inputs:
    notifyUsers: 'w4p-a@outlook.com'
# Continuous Deployment Process for Staging Environment
  - stage: DeployToStaging
    condition: and(succeeded(), eq(variables['build.sourceBranch'], 'refs/heads/master'))
    jobs:
    - job: waitForValidation
      displayName: Wait for external validation
      pool: w7pool
      # timeoutInMinutes: 4320 # job times out in 3 days
      steps:
      - task: ManualValidation@0
        inputs:
          notifyUsers: 'w4p-a@outlook.com'
            
          # instructions: 'Please validate the build configuration and resume'
          # onTimeout: 'resume'
      
    
#   - deployment: staging
#     displayName: Deploy to Staging
#     environment:
#       name: <<YOUR ENVIRONMENT NAME>>
#       resourceType: VirtualMachine
#     strategy:
#       runOnce:
#         deploy:
#           steps:
#           - <<YOUR TASKS>>
          
# Continuous Delivery Process for Production Environment
# - stage: DeployToProduction
#   condition: and(succeeded(), eq(variables['build.sourceBranch'], 'refs/heads/master'))
#   jobs:
#   - deployment: production
#     displayName: Deploy to Production
#     environment:
#       name: <<YOUR ENVIRONMENT NAME>>
#       resourceType: VirtualMachine
    # strategy:
    #   runOnce:
    #     deploy:
    #       steps:
    #       - <<YOUR TASKS>>