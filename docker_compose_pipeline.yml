############################################################

trigger: none
pool:
  name: self-hosted

variables:
      - group: compose_vars
      - group: okta

stages:

  - stage: CI
    jobs:
      - job: build_and_push
        displayName: build docker image
        workspace:
          clean: all
        steps:
          # - task: DownloadSecureFile@1
          #   name: create_env
          #   displayName: 'Download create_env.sh'
          #   inputs:
          #     secureFile: 'create_env.sh'

          - script: |
               sudo apt update && sudo apt-get install -y \
               ca-certificates \
               curl \
               gnupg \
               lsb-release && sudo mkdir -p /etc/apt/keyrings && curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg && echo \
               "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
                $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null && sudo apt-get update && sudo apt-get install docker-ce docker-ce-cli containerd.io docker-compose-plugin -y
                sudo usermod -aG docker $USER && sudo usermod -aG root $USER && sudo chmod 777 /var/run/docker.sock
                sudo apt install docker-compose -y

                # bash $(create_env.secureFilePath) $(ip) $(oip) $(oid) $(ocs) $(pgn) $(pgu) $(pgp) $(port)
                bash ./create_env.sh $(ip) $(oip) $(oid) $(ocs) $(pgn) $(pgu) $(pgp) $(port)
                docker rm -f $(docker ps -q)

                docker-compose --env-file .env up -d --build

                # docker image prune -a -f

            displayName: install docker on agent
